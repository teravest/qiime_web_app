<script src="../americangut/js/jquery.ui.timepicker.js"></script>
<%
__author__ = "Doug Wendel"
__copyright__ = "Copyright 2009-2013, Qiime Web Analysis"
__credits__ = ["Doug Wendel", "Zhenjiang Xu", "Adam Robbins-Pianka"]
__license__ = "GPL"
__version__ = "1.0.0.dev"
__email__ = "zhenjiang.xu@colorado.edu"
__status__ = "Production"

from utils.mail import send_email
from datetime import date

# scan_date = date.today().isoformat()
current_date = date.today().strftime("%m/%d/%Y")

prev_barcode = form.get('prev_barcode', None)
if prev_barcode:
    try: # try to update barcode current status.
        # do not change scan_date if it's already in the database.
        # it's gotten from the html form, so use str representation of None.
        # if form['scan_date'] == 'None': scan_date = current_date
        # else: scan_date = form['scan_date']
        biomass_remaining_value = form.get('biomass_remaining', [])
        biomass_remaining = 'N'
        if 'biomass_remaining_checked' in biomass_remaining_value: biomass_remaining = 'Y'
        data_access.updateBarcodeStatus('Received', form['postmark_date'],
                                        form['scan_date'], prev_barcode,
                                        biomass_remaining,
                                        form['sequencing_status'], 
                                        form['obsolete_status'])
        data_access.setBarcodeProjType(form['project'], prev_barcode)
    
        sent_date = form['sent_date']

        general_name = "American Gut participant"

        login_user = form['login_user'] # kit owner name
        if login_user=="None": login_user = general_name

        if "send_email" in form:
            email_type = form['email_type']
            subject = body_message = ""
            sample_time = form['sample_time']
            sample_date = form['sample_date']
            if email_type == '0':
                subject='Follow up on Your American Gut Sample with Barcode %s' % prev_barcode
                body_message='''
Dear {name},

We have recently received your sample barcode: {barcode}, but we cannot process your sample until the online forms have been completed.  Information about your sample is tracked through the American Gut participant website, and you are required to log in and complete the online process in order for your sample to be processed. 

If it is a human sample, we require formal consent, questionnaire results and sample details (type, date, and time of collection). If it is a pet or environmental sample we require sample details (type, date and time of collection). If you have already filled out the consent form and questionnaire, then it is likely that the sample simply needs to be associated with the appropriate participant.

In order to help you in adding these details, the side of the sample tube {barcode} reads:
   sample date: {sample_date} 
   sample time: {sample_time}

Instructions about the required procedures can be found here: http://www.microbio.me/americangut/img/full_instructions.pdf

These procedures are in place to protect your privacy, and please be sure that we are properly associating your sample to your survey results. We realize that some of these steps may not be completely intuitive. However, our kits are designed to support multiple participants and sample types, which necessitates the added complexity of explicitly requiring participants to associate samples with themselves so that we can guarantee compliance with human subjects research protocols.

Please log back into the American Gut website (http://www.microbio.me/americangut) as soon as possible and complete the online process. If you have any questions or concerns, please contact us at info@americangut.org.

Thank you,

--American Gut Team--
'''

                body_message = body_message.format(name=login_user, barcode=prev_barcode,
                                                   sample_date=sample_date,
                                                   sample_time=sample_time)
            elif email_type == '1':
                subject = 'American Gut Sample with Barcode %s is Received.' % prev_barcode
                body_message = '''
Dear {name},

We have recently received your sample with barcode {barcode} dated {sample_date} {sample_time} and we have begun processing it.  Please see our FAQ section for when you can expect results. (http://www.microbio.me/americangut/FAQ.psp#faq4)

Thank you for your participation!

--American Gut Team--
'''
                body_message = body_message.format(name=login_user, barcode=prev_barcode,
                                                   sample_date=sample_date, sample_time=sample_time)

            

            login_email = form['login_email']

 
            if login_email != "None":
                try:
                    send_email(body_message, subject, login_email)
                    sent_date = current_date
                    req.write("Sent email successfully to kit owner %s<br/>" % login_email)
                except:
                    req.write("Email sending to (%s) failed failed (barcode: %s)!!!<br/>" % (login_email, prev_barcode))
    
        sample_issue = form.get('sample_issue', [])
        moldy = overloaded = other = 'N'
        if 'moldy' in sample_issue: moldy = 'Y'
        if 'overloaded' in sample_issue: overloaded = 'Y'
        if 'other' in sample_issue: other = 'Y'
        ag_data_access.updateAKB(prev_barcode, moldy, overloaded, other,
                                 form['other_text'], sent_date)
        req.write("Barcode %s was sucessfully updated<br/>" % prev_barcode)
    except:
        req.write("Barcode %s update failed!!!<br/>" % prev_barcode)
# de-indent
%>

<div>
<form name="check_barcode" action="fusebox.psp?page=barcode_util.psp" method="post">
    <input id="barcode" name="barcode" type="text" onclick="this.select()" />
    <input type="submit" value="Check Barcode" />
    <script>
        document.check_barcode.barcode.focus()
    </script>
</form>
</div>
<%
try:
    barcode = form['barcode']
    barcodeinfo = ag_data_access.checkBarcode(barcode)
    barcode_metadata = ag_data_access.AGGetBarcodeMetadata(barcode)
    proj_type = data_access.getBarcodeProjType(barcode)
    if len(barcodeinfo)==0:
        req.write('''
         <div id="invalid_barcode" class="verification_color">
            <div class="verification_text_wrapper">
               <br />
                 <h2 class="verification_text">Barcode <br>
                 "%s"
                 <br> does not exist in the database!</h2>
             </div>
         </div>
        ''' % barcode)
    else: 
        sample_site = '' if barcodeinfo[0] == None else barcodeinfo[0]
        sample_date = '' if barcodeinfo[1] == None else barcodeinfo[1]
        sample_time = '' if barcodeinfo[2] == None else barcodeinfo[2]
        moldy = 'NA' if barcodeinfo[3] == None else barcodeinfo[3]
        overloaded = 'NA' if barcodeinfo[4] == None else barcodeinfo[4]
        other = 'NA' if barcodeinfo[5] == None else barcodeinfo[5]
        other_text = '' if barcodeinfo[6] == None else barcodeinfo[6]
        date_of_last_email = '' if barcodeinfo[7] == None else barcodeinfo[7]
        status = '' if barcodeinfo[8] == None else barcodeinfo[8]
        scan_date = 'NA' if barcodeinfo[9] == None else barcodeinfo[9]
        sample_postmark_date = 'NA' if barcodeinfo[10] == None else barcodeinfo[10]
        email = '' if barcodeinfo[11] == None else barcodeinfo[11]
        name = '' if barcodeinfo[12] == None else barcodeinfo[12]
        biomass_remaining = '' if barcodeinfo[13] == None else barcodeinfo[13]
        sequencing_status = '' if barcodeinfo[14] == None else barcodeinfo[14]
        obsolete = '' if barcodeinfo[15] == None else barcodeinfo[15]
        biomass_check = 'checked' if biomass_remaining == 'Y' else ''
        moldy_checked = "checked" if moldy in ('Y','y') else ""
        overloaded_checked = "checked" if overloaded in ('Y','y') else ""
        other_checked = "checked" if other in ('Y','y') else "",
        div_id = message = email_type = ""

        if (barcodeinfo[15] == "Y"):
                #the barcode is obsolete
                div_id = "obsolete"
                message = "Barcode is Obsolete"
        elif not (sample_date == sample_site == sample_time == ''):
            # it has all sample details (sample time, date, site)
            if len(barcode_metadata) == 1:
                # and we can successfully retrieve sample metadata
                div_id = "verified"
                message = "All good"
                email_type = "1"
            elif len(barcode_metadata) == 0:
                # we cannot retrieve metadata
                div_id = "no_metadata"
                message = "Cannot retrieve metadata"
            else:
                # should never get here (this would happen if the metadata
                # pulldown returned more than one row for a single barcode)
                div_id = "md_pulldown_error"
                message = ("This barcode has multiple entries in the "
                           "database, which should never happeen. Please "
                           "notify someone on the database crew.")
        else:
            div_id = "not_assigned"
            message = "Missing info"
            email_type = "0"
        #indent
%>
        
        <div id="{div_id}" class="verification_color">
           <div class="verification_text_wrapper">
              <br />
               
                <h2 class="verification_text">
                 Project type: <%=proj_type%> <br><br>
                 Barcode: <%=barcode%><br><br>
                <%=message%></h2>
            </div>
        </div>

        <div id="barcode_form">
        <form action="fusebox.psp?page=barcode_util.psp" method="post"
         onsubmit="return confirm('Are you sure to submit and update database?')"
         onreset="return confirm('Are you sure to reset?')">
          <input type="hidden" name="prev_barcode" value="<%=barcode%>" />
          <input type="hidden" name="sent_date" value="<%=date_of_last_email%>" />
          <input type="hidden" name="login_user"  value="<%=name%>" />
          <input type="hidden" name="login_email" value="<%=email%>" />
          <input type="hidden" name="email_type" value="<%=email_type%>" />
          <input type="hidden" name="sample_date" id="sample_date" value="<%=sample_date%>"/>
          <input type="hidden" name="sample_time" id="sample_time" value="<%=sample_time%>"/>
          <input type="hidden" name="sample_site" id="sample_site" value="<%=sample_site%>"/>
          <ul>
             <li>
             Sample details: <br/>
             <table>
             <tr><td>Sample Date</td><td><%=sample_date%></td></tr>
             <tr><td>Sample Time</td><td><%=sample_time%></td></tr>
             <tr><td>Sample Site</td><td><%=sample_site%></td></tr>
             </table>
             </li>
             <li>
               Sample issues: <br />
                  <input class="checkbox" type="checkbox" name="sample_issue" id="moldy" value="moldy" <%=moldy_checked%>/> 
                    <label for="moldy"> moldy (current: <%=moldy%>) </label> <br />
                  <input class="checkbox" type="checkbox" name="sample_issue" id="overloaded" value="overloaded" <%=overloaded_checked%>/>
                    <label for="overloaded"> overloaded (current: <%=overloaded%>) </label> <br />
                  <input class="checkbox" type="checkbox" name="sample_issue" id="other" value="other" <%=other_checked%>/>
                    <label for="other"> other (current: <%=other%>) </label> <br />
             </li>
             <li>
               Other notes: <br />
                  <textarea name="other_text" onclick="this.select()"><%=other_text%></textarea>
             </li>
             <li>
               Sample postmark date (current: <%=sample_postmark_date%>) : <br />
                  <input type="text" name="postmark_date" id="postmark_date" value="<%=sample_postmark_date if sample_postmark_date != 'NA' else ''%>" onclick="this.select()" /> <br />
                        <script>
                          $(function() {
                            $( "#postmark_date" ).datepicker({
                                    changeMonth: true,
                                    maxDate: '+0m',
                                    onSelect: function(dateText, inst) {
                                        $(this).focus();
                                    }
                            });
                          });
                        </script>
                  (please follow the format mm/dd/yyyy. Example: 12/25/2012)
             </li>
             <li>
               Scan date (current: <%=scan_date%>): <br />
               <input type="text" name="scan_date" id="scan_date" value="<%=scan_date if scan_date != 'NA' else ''%>" onclick="this.select()" /> <br />
                        <script>
                          $(function() {
                            $( "#scan_date" ).datepicker({
                                    changeMonth: true,
                                    maxDate: '+0m',
                                    onSelect: function(dateText, inst) {
                                        $(this).focus();
                                    }
                            });
                          });
                        </script>
                  (please follow the format mm/dd/yyyy. Example: 12/25/2012)
             </li>
             <li>General Sample Information: <br>
             <table
             <tr><td><input class="checkbox" type="checkbox" name="biomass_remaining" id="biomass_remaining_checked" value="biomass_remaining_checked"<%=biomass_check%>/>
             <label for="biomass_remaining"> Biomass Remaining (current:<%=biomass_remaining%>)</label></td></tr>
             <tr><td>Sequencing Status</td><td><input type="text" name="sequencing_status" id="sequencing_status" value="<%=sequencing_status%>"/></td></tr>
             <tr><td>Obsolete (Y or N)</td><td><input type="text" maxlength="1" name="obsolete_status" id="obsolete_status" value="<%=obsolete%>"/></td></tr>
             </table>
             </li>
             <li>
             <tr><td>Project </td><td><select name="project" id="project" >
<%
        project_names = data_access.getProjectNames()
        current_project = data_access.getBarcodeProjType(barcode)
        for project in project_names:
            if project == current_project:
                req.write('<option value="{0}" selected>{0}</option>'.format(project))
            else:
                req.write('<option value="{0}">{0}</option>'.format(project))
        #End Indent
%>
            </select></td></tr>
            </li>
             <li>
               Send an email notification (previously sent: <%=date_of_last_email%>): <br />
               <table><tr>
                  <td> <input class="checkbox" type="checkbox" name="send_email" id="send_email" value="send_email" style="float:left;" /> </td>
                  <td><label for="send_email" style="display:block;">send kit owner <%=email%> (<%=name%>) an email </label> </td></tr>

<%
        if email_type == '0':
            # indent
%>
            <tr><td></td><td>
            sample date: <input type="text" name="sample_date" id="sample_date" style="width:100px"/> <br/>
                        <script>
                          $(function() {
                            $( "#sample_date" ).datepicker({
                                    changeMonth: true,
                                    maxDate: '+0m',
                                    onSelect: function(dateText, inst) {
                                        $(this).focus();
                                    }
                            });
                          });
                        </script>
            </td></tr>
            <tr><td></td><td>
            sample time: <input type="text" name="sample_time" id="sample_time" style="width:100px"/> <br />
                  <script>
                      $(function() {
                        $( "#sample_time" ).timepicker({
                           showPeriod: true,
                           showLeadingZero: true,
                           onSelect: function(dateText, inst) {
                              $(this).focus();
                           }
                        });
                      });
                  </script>
            </td></tr>
<%
        elif email_type == '1':
            # indent
%>
            <input type="hidden" name="sample_time" value="<%=sample_time%>" />
            <input type="hidden" name="sample_date" value="<%=sample_date%>" />
<%
        # de-indent
%>
            </table>
           </li>
          </ul>
              <input type="submit" value="Submit">
              <input type="reset" value="Reset!">
        </form>
        </div>
<%
except(KeyError):
    #will get here on first load of this page since there should be no barcode key in the form dict
%>
